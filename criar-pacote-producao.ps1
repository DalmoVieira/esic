# Script para criar pacote de produ√ß√£o do E-SIC
# Vers√£o: 1.0.0
# Data: Outubro 2025

Write-Host ""
Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Blue
Write-Host "‚ïë  E-SIC - Gerador de Pacote para Produ√ß√£o                        ‚ïë" -ForegroundColor Blue
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Blue
Write-Host ""

# Vari√°veis
$projectRoot = $PSScriptRoot
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$version = "3.0.0"
$outputFile = "esic_v${version}_producao_${timestamp}.zip"
$tempDir = Join-Path $env:TEMP "esic_build_$timestamp"

Write-Host "üì¶ Criando pacote de produ√ß√£o..." -ForegroundColor Green
Write-Host "Vers√£o: $version" -ForegroundColor Cyan
Write-Host "Diret√≥rio: $projectRoot" -ForegroundColor Cyan
Write-Host ""

# Criar diret√≥rio tempor√°rio
Write-Host "‚ñ∫ Criando diret√≥rio tempor√°rio..." -ForegroundColor Yellow
New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
Write-Host "‚úì Diret√≥rio criado: $tempDir" -ForegroundColor Green
Write-Host ""

# Arquivos e diret√≥rios a incluir
Write-Host "‚ñ∫ Copiando arquivos para produ√ß√£o..." -ForegroundColor Yellow

$includePaths = @(
    # P√°ginas principais
    "index.php",
    "novo-pedido.php",
    "acompanhar.php",
    "transparencia.php",
    "recurso.php",
    
    # Painel administrativo
    "admin-pedidos.php",
    "admin-recursos.php",
    "admin-configuracoes.php",
    
    # API
    "api/",
    
    # Classes e configura√ß√µes
    "app/",
    
    # Assets
    "assets/",
    
    # Banco de dados
    "database/",
    
    # Cron jobs
    "cron/",
    
    # Scripts de deploy
    "deploy.sh",
    "comandos-rapidos.sh",
    
    # Documenta√ß√£o essencial
    "README.md",
    "DEPLOY_PRODUCAO.md",
    "CHECKLIST_DEPLOY.md",
    "CHANGELOG.md",
    "LICENSE",
    
    # Configura√ß√£o
    ".htaccess"
)

# Arquivos e diret√≥rios a excluir
$excludePatterns = @(
    "*.git*",
    ".vscode",
    ".DS_Store",
    "node_modules",
    "vendor",
    "composer.lock",
    "package-lock.json",
    "*.log",
    "*.tmp",
    "thumbs.db",
    
    # Arquivos de desenvolvimento
    "teste-*.php",
    "exemplo-*.php",
    "*-v2.php",
    "diagnostico.php",
    "test_*.php",
    
    # Documenta√ß√£o de desenvolvimento
    "CONTRIBUTING.md",
    "README_FASE*.md",
    "RELEASE_NOTES.md",
    "SUMARIO_EXECUTIVO.md",
    "PROJETO_STATUS.txt",
    "projeto-completo.html",
    "SETUP_MACOS.md",
    "setup-macos.sh",
    
    # Diret√≥rios tempor√°rios
    "logs",
    "uploads"
)

# Copiar arquivos
$fileCount = 0
foreach ($path in $includePaths) {
    $sourcePath = Join-Path $projectRoot $path
    
    if (Test-Path $sourcePath) {
        $destPath = Join-Path $tempDir $path
        
        if (Test-Path $sourcePath -PathType Container) {
            # √â um diret√≥rio
            Write-Host "  Copiando diret√≥rio: $path" -ForegroundColor Gray
            
            # Criar diret√≥rio de destino
            $destDir = Split-Path $destPath -Parent
            if (-not (Test-Path $destDir)) {
                New-Item -ItemType Directory -Path $destDir -Force | Out-Null
            }
            
            # Copiar recursivamente excluindo padr√µes
            Copy-Item -Path $sourcePath -Destination $destPath -Recurse -Force
            
            # Remover arquivos exclu√≠dos
            foreach ($pattern in $excludePatterns) {
                Get-ChildItem -Path $destPath -Recurse -Force -Include $pattern | Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
            }
            
            $count = (Get-ChildItem -Path $destPath -Recurse -File).Count
            $fileCount += $count
            Write-Host "    ‚úì $count arquivos copiados" -ForegroundColor Green
        }
        else {
            # √â um arquivo
            Write-Host "  Copiando arquivo: $path" -ForegroundColor Gray
            
            $destDir = Split-Path $destPath -Parent
            if (-not (Test-Path $destDir)) {
                New-Item -ItemType Directory -Path $destDir -Force | Out-Null
            }
            
            Copy-Item -Path $sourcePath -Destination $destPath -Force
            $fileCount++
            Write-Host "    ‚úì Arquivo copiado" -ForegroundColor Green
        }
    }
    else {
        Write-Host "  ‚ö† N√£o encontrado: $path" -ForegroundColor Yellow
    }
}

Write-Host ""
Write-Host "‚úì Total de $fileCount arquivos copiados" -ForegroundColor Green
Write-Host ""

# Criar diret√≥rios vazios necess√°rios
Write-Host "‚ñ∫ Criando diret√≥rios vazios necess√°rios..." -ForegroundColor Yellow

$emptyDirs = @(
    "uploads",
    "logs",
    "logs/cron",
    "logs/apache"
)

foreach ($dir in $emptyDirs) {
    $dirPath = Join-Path $tempDir $dir
    New-Item -ItemType Directory -Path $dirPath -Force | Out-Null
    
    # Criar .gitkeep para manter o diret√≥rio no Git
    $gitkeepPath = Join-Path $dirPath ".gitkeep"
    "" | Out-File -FilePath $gitkeepPath -Encoding UTF8
    
    Write-Host "  ‚úì Criado: $dir" -ForegroundColor Green
}

Write-Host ""

# Criar arquivo de prote√ß√£o para uploads
Write-Host "‚ñ∫ Criando arquivo de prote√ß√£o para uploads..." -ForegroundColor Yellow
$htaccessUploadsContent = @'
# Prote√ß√£o do diret√≥rio de uploads
# Bloqueia acesso direto a arquivos PHP

<Files *.php>
    Order Deny,Allow
    Deny from all
</Files>

# Permitir apenas tipos de arquivo espec√≠ficos
<FilesMatch "\.(jpg|jpeg|png|gif|pdf|doc|docx|xls|xlsx|zip)$">
    Order Allow,Deny
    Allow from all
</FilesMatch>
'@

$htaccessUploadsPath = Join-Path $tempDir "uploads"
$htaccessUploadsPath = Join-Path $htaccessUploadsPath ".htaccess"
$htaccessUploadsContent | Out-File -FilePath $htaccessUploadsPath -Encoding UTF8
Write-Host "  ‚úì .htaccess criado em uploads/" -ForegroundColor Green
Write-Host ""

# Criar arquivo README para produ√ß√£o
Write-Host "‚ñ∫ Criando README de instala√ß√£o..." -ForegroundColor Yellow
$readmeContent = @"
# E-SIC v$version - Pacote de Produ√ß√£o

Data de gera√ß√£o: $(Get-Date -Format "dd/MM/yyyy HH:mm:ss")

## Conte√∫do do Pacote

Este pacote cont√©m todos os arquivos necess√°rios para deploy em produ√ß√£o do sistema E-SIC.

## Instala√ß√£o R√°pida

### Op√ß√£o 1: Script Automatizado (Recomendado)

bash
# 1. Extrair o ZIP no servidor
unzip esic_v${version}_producao_*.zip -d /var/www/

# 2. Entrar no diret√≥rio
cd /var/www/esic

# 3. Executar script de deploy
chmod +x deploy.sh
sudo ./deploy.sh


### Op√ß√£o 2: Manual

Consulte o arquivo DEPLOY_PRODUCAO.md para instru√ß√µes detalhadas.

## Checklist P√≥s-Instala√ß√£o

Verifique todos os itens ap√≥s a instala√ß√£o.

## Estrutura de Diret√≥rios

Confira a organiza√ß√£o dos arquivos no sistema.

## Configura√ß√µes Necess√°rias

### 1. Banco de Dados
Edite o arquivo app/config/Database.php

### 2. Importar Schema
Use o arquivo database/schema_novo.sql

### 3. Configurar Permiss√µes
Configure as permiss√µes corretas

### 4. Configurar Cron
Configure o agendamento de tarefas

## Seguran√ßa

Certifique-se de configurar SSL/TLS e firewall.

## Suporte

- Documenta√ß√£o: DEPLOY_PRODUCAO.md
- Checklist: CHECKLIST_DEPLOY.md
- GitHub: https://github.com/DalmoVieira/esic

## Licen√ßa

MIT License - Copyright (c) 2025 Prefeitura Municipal de Rio Claro - SP

Desenvolvido com amor para a transpar√™ncia p√∫blica
"@

$readmeProducaoPath = Join-Path $tempDir "LEIA-ME.txt"
$readmeContent | Out-File -FilePath $readmeProducaoPath -Encoding UTF8
Write-Host "  ‚úì LEIA-ME.txt criado" -ForegroundColor Green
Write-Host ""

# Criar arquivo de vers√£o
Write-Host "‚ñ∫ Criando arquivo de vers√£o..." -ForegroundColor Yellow
$versionInfo = @"
E-SIC - Sistema Eletr√¥nico de Informa√ß√µes ao Cidad√£o
Vers√£o: $version
Build: $timestamp
Data: $(Get-Date -Format "dd/MM/yyyy HH:mm:ss")
Tipo: Produ√ß√£o
Status: Production Ready

Conte√∫do:
- Sistema completo de pedidos
- Sistema de anexos
- Notifica√ß√µes por email
- Painel administrativo
- Sistema de recursos
- Documenta√ß√£o completa
- Scripts de deploy

Requisitos:
- PHP 8.0+
- MySQL 8.0+
- Apache 2.4+ ou Nginx 1.18+
- SSL/TLS
- 2GB RAM m√≠nimo
- 10GB disco m√≠nimo

Desenvolvido por: Dalmo Vieira
√ìrg√£o: Prefeitura Municipal de Rio Claro - SP
Licen√ßa: MIT
"@

$versionPath = Join-Path $tempDir "VERSION.txt"
$versionInfo | Out-File -FilePath $versionPath -Encoding UTF8
Write-Host "  ‚úì VERSION.txt criado" -ForegroundColor Green
Write-Host ""

# Criar arquivo .env.example
Write-Host "‚ñ∫ Criando arquivo .env.example..." -ForegroundColor Yellow
$envExample = @"
# Configura√ß√µes do Banco de Dados
DB_HOST=localhost
DB_NAME=esic_db
DB_USER=esic_user
DB_PASS=senha_segura_aqui

# Configura√ß√µes de Email (SMTP)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=seu-email@gmail.com
SMTP_PASS=sua-senha-aqui
SMTP_FROM=noreply@rioclaro.sp.gov.br
SMTP_FROM_NAME=E-SIC Rio Claro

# Configura√ß√µes do Sistema
BASE_URL=https://esic.rioclaro.sp.gov.br
TIMEZONE=America/Sao_Paulo
DEBUG=false

# Configura√ß√µes de Upload
UPLOAD_MAX_SIZE=10485760
UPLOAD_ALLOWED_TYPES=pdf,doc,docx,xls,xlsx,jpg,jpeg,png,gif,zip

# Configura√ß√µes de Seguran√ßa
SESSION_LIFETIME=7200
CSRF_TOKEN_ENABLED=true
"@

$envExamplePath = Join-Path $tempDir ".env.example"
$envExample | Out-File -FilePath $envExamplePath -Encoding UTF8
Write-Host "  ‚úì .env.example criado" -ForegroundColor Green
Write-Host ""

# Criar arquivo de checksums
Write-Host "‚ñ∫ Gerando checksums MD5..." -ForegroundColor Yellow
$checksums = @()
Get-ChildItem -Path $tempDir -Recurse -File | ForEach-Object {
    $hash = (Get-FileHash -Path $_.FullName -Algorithm MD5).Hash
    $relativePath = $_.FullName.Replace($tempDir + "\", "")
    $checksums += "$hash  $relativePath"
}

$checksumsPath = Join-Path $tempDir "CHECKSUMS.md5"
$checksums | Out-File -FilePath $checksumsPath -Encoding UTF8
Write-Host "  ‚úì CHECKSUMS.md5 gerado com $($checksums.Count) arquivos" -ForegroundColor Green
Write-Host ""

# Criar arquivo ZIP
Write-Host "‚ñ∫ Criando arquivo ZIP..." -ForegroundColor Yellow
$zipPath = Join-Path $projectRoot $outputFile

# Remover ZIP anterior se existir
if (Test-Path $zipPath) {
    Remove-Item $zipPath -Force
}

# Criar ZIP
Add-Type -Assembly System.IO.Compression.FileSystem
$compressionLevel = [System.IO.Compression.CompressionLevel]::Optimal
[System.IO.Compression.ZipFile]::CreateFromDirectory($tempDir, $zipPath, $compressionLevel, $false)

Write-Host "  ‚úì ZIP criado: $outputFile" -ForegroundColor Green
Write-Host ""

# Obter tamanho do arquivo
$zipSize = (Get-Item $zipPath).Length
$zipSizeMB = [math]::Round($zipSize / 1MB, 2)

# Limpar diret√≥rio tempor√°rio
Write-Host "‚ñ∫ Limpando arquivos tempor√°rios..." -ForegroundColor Yellow
Remove-Item -Path $tempDir -Recurse -Force
Write-Host "  ‚úì Diret√≥rio tempor√°rio removido" -ForegroundColor Green
Write-Host ""

# Resumo final
Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
Write-Host "‚ïë  ‚úì Pacote de Produ√ß√£o Criado com Sucesso!                       ‚ïë" -ForegroundColor Green
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Green
Write-Host ""
Write-Host "üì¶ Arquivo: " -NoNewline -ForegroundColor Cyan
Write-Host "$outputFile" -ForegroundColor White
Write-Host "üìä Tamanho: " -NoNewline -ForegroundColor Cyan
Write-Host "$zipSizeMB MB" -ForegroundColor White
Write-Host "üìÅ Localiza√ß√£o: " -NoNewline -ForegroundColor Cyan
Write-Host "$zipPath" -ForegroundColor White
Write-Host "üìù Arquivos: " -NoNewline -ForegroundColor Cyan
Write-Host "$fileCount arquivos inclu√≠dos" -ForegroundColor White
Write-Host ""

Write-Host "üìã Conte√∫do do pacote:" -ForegroundColor Yellow
Write-Host "  Sistema completo E-SIC" -ForegroundColor Gray
Write-Host "  APIs REST" -ForegroundColor Gray
Write-Host "  Painel administrativo" -ForegroundColor Gray
Write-Host "  Sistema de anexos" -ForegroundColor Gray
Write-Host "  Notifica√ß√µes por email" -ForegroundColor Gray
Write-Host "  Scripts de deploy" -ForegroundColor Gray
Write-Host "  Documenta√ß√£o essencial" -ForegroundColor Gray
Write-Host "  Schema do banco de dados" -ForegroundColor Gray
Write-Host ""

Write-Host "üöÄ Pr√≥ximos passos:" -ForegroundColor Yellow
Write-Host "  1. Transfira o arquivo ZIP para o servidor" -ForegroundColor Gray
Write-Host "  2. Extraia: unzip $outputFile -d /var/www/" -ForegroundColor Gray
Write-Host "  3. Execute: sudo ./deploy.sh" -ForegroundColor Gray
Write-Host "  4. Consulte: DEPLOY_PRODUCAO.md" -ForegroundColor Gray
Write-Host ""

Write-Host "Desenvolvido com amor para a Prefeitura de Rio Claro - SP" -ForegroundColor Cyan
Write-Host ""
